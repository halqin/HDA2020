---
title: "Analysis of High Dimensional Data - Lab 4"
subtitle: "Sparse PCA and LDA"
author: "Adapted by Milan Malfait"
date: "19 Nov 2020"
references:
- id: alon1999broad
  type: article-journal
  author:
  - family: Alon
    given: Uri
  - family: Barkai
    given: Naama
  - family: Notterman
    given: Daniel A
  - family: Gish
    given: Kurt
  - family: Ybarra
    given: Suzanne
  - family: Mack
    given: Daniel
  - family: Levine
    given: Arnold J
  issued:
  - year: 1999
  title: Broad patterns of gene expression revealed by clustering analysis of tumor
    and normal colon tissues probed by oligonucleotide arrays
  container-title: Proceedings of the National Academy of Sciences
  publisher: National Acad Sciences
  page: 6745-6750
  volume: '96'
  issue: '12'
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  out.width = "100%"
)
```

***

# Introduction

**In this lab session we will look at the following topics**

  - Methods to set some of the loadings exactly to zero in a PCA.
  - Use `glmnet()` to add penalties on principal component loadings.
  - Use LDA to understand differences between groups in a high dimensional space.
  
## The dataset {-}

In this practical session, we use the dataset by @alon1999broad on
gene expression levels in 40 tumour and 22 normal colon tissue samples.
They checked a total of 6500 human genes using the Affymetrix oligonucleotide array. You can read the data in as follows:

```{r read in data}
Alon1999 <- read.csv("doc/Lab4/Alon1999.csv")
```

The dataset contains one variable named `Y` with the values `t` and `n`.
This variable indicates whether the sample came from tumourous (`t`) or
normal (`n`) tissue.

The goal of this practical is to find the best subset/combination of genes to detect tumourous tissue.
As in @alon1999broad, we use the 2000 genes with the highest minimal intensity
across the samples.

# Sparse PCA

In order to work easily with the data, first construct a scaled matrix
`X` and a vector `Y` which gives the scaled predictors and the respons
variable:

```{r}
X <- scale(Alon1999[, -1])
Y <- as.factor(Alon1999[, 1])
```

Use these objects to solve the following exercises.

## Exercises {-}

#### 1. Perform a SVD on `X`, and store the scores of the PCs in a matrix `Z`. {-}

  <!-- Solution -->

#### 2. Plot the singular values and confirm that the first and second PCs can approximate the data to some extent. {-}

  <!-- Solution -->

#### 3. Plot the first two PCs and use different colours for tumour/normal tissue. {-}

  <!-- Solution -->

#### 4. Plot histograms of the loadings of the first and second PCs. Which loadings will you pick as the most important ones? {-}

  <!-- Solution -->

#### 5. We know that the first PC $\mathbf{Z_1}$, is given by {-}

  $$
  \mathbf{Z_1}=\mathbf{X} \mathbf{V_1}
  $$

  Where $\mathbf{V_1}$ are the loadings of the first PC. If we put this in regression notation, we get

  $$
  \mathbf{Y}=\mathbf{X}\boldsymbol{\beta}
  $$ 

  where $\boldsymbol{\beta}$ now represent the $\mathbf{V_1}$ loadings, and
  $\mathbf{Y}$ is $\mathbf{Z_1}$.

  Recall that the ridge regression solution for $\boldsymbol{\beta}$ is given by

  $$
  \boldsymbol{\beta}_{\text{ridge}}
    = (\mathbf{X^TX}+\gamma\mathbf{I})^{-1}\mathbf{X}^T\mathbf Y
  $$

  __Question:__ Replace $\mathbf{Y}$ with $\mathbf{Z_1}$ and verify in 
  `R` that

  $$
  \mathbf V_1 = 
    \frac{\boldsymbol\beta_{\text{ridge}}}{\|\boldsymbol\beta_{\text{ridge}}\|_2}
  $$

  for any $\gamma > 0$ of your choice.
  Remember that
  $\|\boldsymbol\beta_{\text{ridge}}\|_2 = \sqrt{\sum_{j=1}^p \beta_j^2}$

  <!-- Solution -->

  Then you've proven that the loadings of the PCs can be computed from the
  ridge regression coefficients.
  
  We can now move on to sparse PCA, where we use penalised regression to set some of the loadings ($\boldsymbol{\beta}$s) to zero.

#### 6. We have seen elastic net type penalties. If we call the loadings of the first PC as $\boldsymbol{\beta}$ and denote PC1 as $\mathbf{Y}$, we saw that $\boldsymbol{\beta}$ can be derived by minimising the SSE: {-}

  $$
  \text{SSE}=\|\mathbf Y-\mathbf{X}\boldsymbol \beta\|^2_2+\gamma\|\boldsymbol \beta\|^2_2 \text{ for any } \gamma>0).
  $$

  Note that this equality holds for all positive $\gamma$, whatsoever. So we can't penalise the $\boldsymbol\beta$s not being zero by choosing a different $\gamma$. Fortunately we have other tools. 

  In addition to the $L_2$ penalization, we can use the $L_1$ penalization of Lasso. This allows us to force some of the $\boldsymbol\beta$s to become zero. The new SSE will be of the form:

  $$
  \text{SSE}=\|\mathbf Y-\mathbf{X}\boldsymbol \beta\|^2_2+\gamma\|\boldsymbol \beta\|^2_2 +\gamma_1\|\boldsymbol \beta\|_1.
  $$

  This is exactly the elastic net SSE, and $\gamma_1$ is the Lasso type penalty that sets loadings to zero. 

  Now use the `glmnet` and `cv.glmnet` functions to select an appropriate number of non-zero loadings for the first and second PCs. Note that for elastic net, `cv.glmnet` takes `alpha=0.5`. Then you replace $\mathbf Y$ with `Z1` for PC1 and `Z2` for PC2.

  <!-- Solution -->
  
#### 7. Plot your newly derived first and second PCs and use different colors for the tumor and normal tissues. How well do these new PCs separate the response classes? Compare this to the plot in exercise 3. Formulate a conclusion based on the two graphs. {-}

In order to plot different colors and add a legend with base `R` plotting, you can do the following:

```{r}
cols <- c("n" = "red", "t" = "blue")
plot(X[, 1], X[, 2], col = cols[Y], pch = 19)
legend("bottomright", c("Normal", "Tumorous"), col = c("red", "blue"), pch = 19)
```

This plots the first two dimensions of the `X` (!) matrix with solid
points (`pch = 19`), and the color red for normal tissue and blue for
tumorous tissue. You can adapt this code to create the proper plot.

  <!-- Solution -->


# LDA

In this section, we will perform LDA on the gene data to get a clear understanding on the genes responsible for separating the tumor and normal tissue groups.

Remember that the LDA problem can be stated as

$$
\mathbf v=\text{ArgMax}_a\frac{\boldsymbol a^t \mathbf B \boldsymbol a}{\boldsymbol a^t \mathbf W \boldsymbol a} \text{ subject to }
\boldsymbol a^t \mathbf W \boldsymbol a=1.
\$$

Which is equivalent to the eigenvalue/eigenvector problem 

$$
\mathbf W^{-1} \mathbf B \boldsymbol a=\lambda \boldsymbol a
$$

In our case where we only have two groups, only one solution exist. This is the one eigenvector $\boldsymbol v$ and one eigenvalue. We can then write the PC/Scores as

$$
\mathbf Z=\mathbf X \boldsymbol v
$$


## Exercises {-}

#### 1. Load the package `MASS` by using the command `library(MASS)` {-}

  <!-- Solution -->

#### 2. The function `lda()` in the `MASS` package performs LDA. Similar to the `glmnet()` function, you will need to supply an `x` argument. The argument `grouping` is the vector with the response, and this has to be a factor variable. You have that stored as `Y`. Fit an LDA on `X` with grouping `Y`. Call your fit `Alon1999.lda`. {-}

  <!-- Solution -->

#### 3. $\boldsymbol v$ can be extracted from the object as the element `scaling` (i.e. `Alon1999.lda$scaling` gives you $\boldsymbol v$). Extract this and call it `V1`. {-}

  <!-- Solution -->

#### 4. Compute $\mathbf Z$ and call it `Z1`. {-}

  <!-- Solution -->

#### 5. Now check to see how well your single LDA/`Z1` separates the tumour and normal tissues groups. Compare it to the plot in (3) of the previous exercise, and observe whether LDA performs better in separating the two groups. {-}

  <!-- Solution -->

#### 6. As was the case with the first and second PC, `Z1` is a linear combination determined by the loadings $\boldsymbol v$. These are non-zero for all genes. To get a few interesting genes, you can use a sparse LDA. Note that you can use the package `sparseLDA` with the function `sda()` to perform this analysis, but let's do this as we did for sparse PCA. {-}

a. Use the `cv.glmnet` function with `x=X`, `y=Z1` and `alpha=0.5` to select an appropriate number of non-zero genes for the LDA.

  <!-- Solution -->

b. Check to see how well this subset of genes does in separating the tumour and normal tissue groups. Are they as effective as the entire set of genes? You may use AUC/ROC curves to check this.

  <!-- Solution -->


# References {-}
