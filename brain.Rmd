---
title: "Large scale inference"
author: "Lieven Clement"
date: "statOmics, Ghent University (https://statomics.github.io)"
output:
    html_document:
      code_download: true
      theme: cosmo
      toc: true
      toc_float: true
      highlight: tango
      number_sections: true
---

# Motivation: Brain Imaging Example

## Background

Diffusion Tensor Imaging:

Diffusion tensor imaging (DTI) is a magnetic resonance imaging technique that enables the measurement of the restricted diffusion of water in tissue in order to produce neural tract images.

Imaging and interpretation of water diffusion have improved with the development of diffusion tensor imaging (DTI). DTI allows direct in vivo examination of aspects of the tissue microstructure. DTI takes advantage of diffusion anisotropy to provide excellent details of the brain; for example, it enables mapping of the orientation of the white-matter tracts.

Diffusion tensor imaging (DTI) may be used to map and characterize the three-dimensional diffusion of water as a function of spatial location. The diffusion tensor describes the magnitude, the degree of anisotropy, and the orientation of diffusion anisotropy. Estimates of white matter connectivity patterns in the brain from white matter tractography may be obtained using the diffusion anisotropy and the principal diffusion directions.

## Data

data from 6 normal and 6 dyslexic children
- from each child, DTI produced observations on 15443 voxels (voxel = small volume at a particular (x, y, x) coordinate)
- for each voxel, a two-sided two-sample t-test has been performed, resulting in a p-value (15443 p-values)
- research question: at what brain locations (voxels) show dyslexic children a different brain activity as compared to normal children?

For each voxel separately, this is a simple problem, but the large scale of the problem (15443 simultaneous hypothesis tests) causes the problem of multiplicity.

The dataset `dti` contains

- Spatial location (x, y, z) of each voxel
- z-statistic for assessing differential brain activity between dyslexic and non-dyslexic children
- Positive z-value higher activity in dyslexic than non-dyslexic children
- Negative z-value lower activity in dyslexic than non-dyslexic children.

## Data exploration

```{r}
library(tidyverse)
library(locfit)
library(gganimate)

dti <- read_csv("https://raw.githubusercontent.com/statOmics/HDA2020/data/dti.csv")
```

```{r}
pZ <- dti %>%
  ggplot(
    aes(
      coord.x,
      coord.y,
      color=z.value)
    ) +
  geom_point() +
  scale_colour_gradient2(low = "blue",mid="white",high="red") +
  transition_manual(coord.z) +
  labs(title = "transection z = {frame}")
```

We will now plot the animated graph

```{r eval=FALSE}
pZ
```

```{r echo=FALSE, message=FALSE}
pZ
```

We visualise the test-statistic of each test per voxel!

Note, that it is difficult to see structure in the data.

# Inference

We can convert the z-statistic in a two-sided p-value for each voxel to assess
\[H_0$: \text{There is on average no difference in brain activity in voxel xyz between dyslexic and non-dyslexic children\]
  \[\mu_d=\mu_{nd}\]

vs

\[H_0: \text{There is on average a difference in brain activity in voxel xyz between dyslexic and non-dyslexic children\]
  \[\mu_d\neq\mu_{nd}\]


Below, we calculate the p-values and a variable zP for which we keep the z-value if it is statistical significant at the 5% level.

```{r}
dti <- dti %>%
  mutate(
    p.value = pnorm(abs(z.value),lower=FALSE)*2,
    zP = (p.value < 0.05) * z.value)

pPval <- dti %>%
  ggplot(
    aes(
      coord.x,
      coord.y,
      color=zP)
    ) +
  geom_point() +
  scale_colour_gradient2(low = "blue",mid="white",high="red") +
  labs(title = "transection z = {frame}")
```


We will now plot the animated graph

```{r eval=FALSE}
pPval
```

```{r echo=FALSE, message=FALSE}
pPval
```

It is much more easy to observe patterns of activity.
Note, that
- the upregulation (z > 0 and p < 0.05) in dyslexic children is appearing in spatial patterns in some locations.
- the downregulation (z < 0 and p > 0.05) is scattered throughout the brain.
- Multiple testing problem.
- If there would be no association between brain activity and dyslexia we can expect on average `r nrow(dti) * 0.05` false positive voxels.
- Note, that only `r sum(dti$p.value < 0.05)` were significant at the 5% significance level, so we can expect that the majority of the returned voxels are false positives. 

```{r}
FPexpected  <- nrow(dti) * 0.05
Preported <- sum(dti$p.value < 0.05)

FPexpected
Preported
```

# Remaining Analysis

```{r}
dti <- dti %>%
  mutate(
    FDR = p.adjust(p.value,"fdr"),
    zFDR = (FDR<0.05) * z.value,
    lfdr = locfdr(dti$z.value)$fdr,
    zfdr = (lfdr<0.2) * z.value)





pFDR <- dti %>%
  ggplot(
    aes(
      coord.x,
      coord.y,
      color=zFDR)
    ) +
  geom_point() +
  scale_colour_gradient2(low = "blue",mid="white",high="red")

pfdr <- dti %>%
  ggplot(
    aes(
      coord.x,
      coord.y,
      color=zfdr)
    ) +
  geom_point() +
  scale_colour_gradient2(low = "blue",mid="white",high="red")
```

## all
```{r echo=FALSE, message=FALSE}
pZ +
 transition_manual(coord.z)
```

## P-values
```{r echo=FALSE, message=FALSE}
pPval +
 transition_manual(coord.z)
```

## FDR

```{r echo=FALSE, message=FALSE}
pFDR +
 transition_manual(coord.z)
```



## local fdr

```{r echo=FALSE, message=FALSE}
pfdr +
 transition_manual(coord.z)
```
